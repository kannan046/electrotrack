<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f6f9; }
        .sidebar { width: 250px; height: 100vh; background: #133B88; padding: 20px; color: white; position: fixed; top: 0; left: 0; }
        .sidebar a { display: block; color: white; padding: 12px 10px; margin-bottom: 5px; text-decoration: none; border-radius: 5px; font-size: 15px; }
        .sidebar a.active, .sidebar a:hover { background: #1D4ED8; }
        .topbar { height: 60px; background: white; padding: 15px 25px; border-bottom: 1px solid #ddd; margin-left: 250px; }
        .btn { border-radius: 8px; }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <h4>Menu</h4>
    <!--<a href="/accounts/employee-dashboard/">Dashboard</a>-->
    <a href="/accounts/attendance/" class="active">My Attendance</a>
    <!--<a href="/accounts/work-reports/">Work Reports</a>
    <a href="/accounts/material-requests/">Material Requests</a>-->
</div>

<!-- Topbar -->
<div class="topbar d-flex justify-content-between align-items-center">
    <h4 class="m-0">My Attendance</h4>
    <div>
        Welcome, <b>{{ request.user.username }}</b>
        <a href="/accounts/logout/" class="btn btn-danger btn-sm ms-3">Logout</a>
    </div>
</div>

<!-- Main -->
<div class="container" style="margin-left: 270px; margin-top: 30px;">
    {% if messages %}
    <div>
        {% for msg in messages %}
        <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="card shadow-sm p-4 mb-4">
        <h5>Mark Attendance</h5>
        <form method="POST" id="attendanceForm">
            {% csrf_token %}
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <button type="submit" name="action" value="clock_in" class="btn btn-success me-2">Clock In</button>
            <button type="submit" name="action" value="clock_out" class="btn btn-danger">Clock Out</button>
        </form>
        <small class="text-muted">Your location will be automatically captured.</small>
    </div>

    <div class="card shadow-sm p-4">
        <h5>Attendance History</h5>
        <table class="table table-striped mt-3">
            <thead>
                <tr class="text-uppercase text-muted small">
                    <th>Date</th>
                    <th>Clock In</th>
                    <th>Clock Out</th>
                    <th>Hours</th>
                    <th>Status</th>
                    <th>Map</th>
                </tr>
            </thead>
            <tbody>
                {% for record in attendance %}
                <tr>
                    
                    <td>
                        {% if record.date %}
                        {{ record.date|date:"Y-m-d" }}
                        {% elif record.timestamp %}
                        {{ record.timestamp|date:"Y-m-d" }}
                        {% else %}
                           —
                        {% endif %}
                    </td>

                    <td>{{ record.clock_in|date:"H:i" }}</td>
                    <td>{{ record.clock_out|date:"H:i" }}</td>

                    <td>
                        {% if record.clock_in and record.clock_out %}
                        {{ record.hours_worked }} hrs
                        {% else %}
                            —
                        {% endif %}
                    </td>


                    <td>
                        <span class="badge 
                            {% if record.status == 'approved' %}bg-success
                            {% elif record.status == 'rejected' %}bg-danger
                            {% else %}bg-warning{% endif %}">
                            {{ record.status|title }}
                        </span>
                    </td>
                    <td>
                        {% if record.latitude and record.longitude %}
                        <a href="https://www.google.com/maps?q={{ record.latitude }},{{ record.longitude }}"
                           target="_blank">View</a>
                        {% else %}
                        —
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted">No records yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Capture live location
    document.addEventListener("DOMContentLoaded", () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById("latitude").value = pos.coords.latitude;
                    document.getElementById("longitude").value = pos.coords.longitude;
                },
                (err) => console.warn("Location error:", err.message)
            );
        }
    });
</script>

</body>
</html>
