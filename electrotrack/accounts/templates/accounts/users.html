<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f4f6f9; }
        .sidebar { height: 100vh; background: #133B88; padding: 20px; color: white; }
        .sidebar a { display: block; color: white; padding: 12px 10px; margin-bottom: 5px; text-decoration: none; border-radius: 5px; }
        .sidebar a.active, .sidebar a:hover { background: #1D4ED8; }
        .topbar { background: white; padding: 15px 25px; border-bottom: 1px solid #ddd; }
        .card-custom { border-radius: 8px; padding: 20px; }
        .btn-blue { background: #1D4ED8; color: white; }
        .btn-blue:hover { background: #0F3BB5; }
    </style>
</head>

<body>

<div class="d-flex">

    <!-- ✅ LEFT SIDEBAR -->
    <div class="sidebar" style="width: 250px;">
        <h4>Menu</h4>
        <a href="/accounts/dashboard/">Dashboard</a>
        <a href="/accounts/users/" class="active">Users</a>
        <a href="/accounts/attendance/">Attendance</a>
        <a href="/accounts/work-reports/">Work Reports</a>
        <a href="{% url 'accounts:material_requests' %}">Material Requests</a>
    </div>

    <!-- ✅ MAIN CONTENT -->
    <div class="flex-grow-1">

        <!-- ✅ TOP NAVBAR -->
        <div class="topbar d-flex justify-content-between">
            <h4>Workforce Management</h4>
            <div>
                Welcome, <b>{{ request.user.username }}</b>
                <a href="/accounts/logout/" class="btn btn-danger btn-sm ms-3">Logout</a>
            </div>
        </div>

        <!-- ✅ USER MANAGEMENT CARD -->
        <div class="container mt-4">
            <div class="card card-custom shadow-sm">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>User Management</h5>

                    <!-- ✅ Add User Button -->
                    <button class="btn btn-blue" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        Add User
                    </button>
                </div>

                <!-- ✅ USERS TABLE -->
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>NAME</th>
                            <th>EMAIL</th>
                            <th>ROLE</th>
                            <th>Site Location</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.role }}</td>
                            <td>{{ user.site_location|default:"-" }}</td>


                            <td>
                                <!-- ✅ EDIT BUTTON -> triggers modal -->
                                <button 
                                    class="btn btn-secondary btn-sm"
                                    onclick="openEditModal('{{ user.id }}', '{{ user.username }}', '{{ user.email }}', '{{ user.role }}')">
                                    Edit
                                </button>

                                <!-- ✅ DELETE -->
                                <a href="/accounts/users/delete/{{ user.id }}/" 
                                   class="btn btn-danger btn-sm"
                                   onclick="return confirm('Delete this user?');">
                                   Delete
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No users found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </div>
    </div>
</div>

<!-- ✅ ADD USER MODAL -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <form method="POST" action="/accounts/users/add/">
                {% csrf_token %}

                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <label>Name</label>
                    <input type="text" name="name" class="form-control mb-3" required>

                    <label>Email</label>
                    <input type="email" name="email" class="form-control mb-3">
                    
                    <label>Site Location</label>
                    <input type="text" name="site_location" class="form-control mb-3" placeholder="Enter site or branch location">


                    <label>Role</label>
                    <select name="role" class="form-select mb-3">
                        <option value="admin">Admin</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="electrician">Electrician</option>
                        <option value="storekeeper">Storekeeper</option>
                    </select>

                    <label>Password</label>
                    <input type="password" name="password" class="form-control" required>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                    <button class="btn btn-blue" type="submit">Save User</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- ✅ EDIT USER MODAL -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-2">

      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="editUserForm" method="POST">
        {% csrf_token %}

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Name</label>
            <input 
              type="text" 
              id="edit_name" 
              name="name" 
              class="form-control"
              required
            >
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input 
              type="email" 
              id="edit_email" 
              name="email" 
              class="form-control"
            >
          </div>

          <div class="mb-3">
            <label class="form-label">Password</label>
            <input 
              type="password" 
              id="edit_password" 
              name="password" 
              class="form-control" 
              placeholder="Leave blank to keep unchanged"
            >
          </div>

          <div class="mb-3">
            <label class="form-label">Role</label>
            <select 
              id="edit_role" 
              name="role" 
              class="form-select"
              required
            >
              <option value="admin">Admin</option>
              <option value="supervisor">Supervisor</option>
              <option value="electrician">Electrician</option>
              <option value="storekeeper">Storekeeper</option>
            </select>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-blue">
            Save User
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<!-- ✅ JS LOGIC FOR EDIT MODAL -->
<script>
function openEditModal(id, name, email, role) {
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_role').value = role;
    document.getElementById('edit_password').value = "";

    // Set action dynamically
    document.getElementById('editUserForm').action = `/accounts/users/edit/${id}/`;

    // Show modal
    new bootstrap.Modal(document.getElementById('editUserModal')).show();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
